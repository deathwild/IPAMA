<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PENDATAAN IPAMA</title>
  <style>
    :root {
      --color-background: rgba(252, 252, 249, 1);
      --color-surface: rgba(255, 255, 253, 1);
      --color-text: rgba(19, 52, 59, 1);
      --color-text-secondary: rgba(98, 108, 113, 1);
      --color-primary: rgba(33, 128, 141, 1);
      --color-primary-hover: rgba(29, 116, 128, 1);
      --color-border: rgba(94, 82, 64, 0.2);
      --color-card-border: rgba(94, 82, 64, 0.12);
      --color-success: rgba(33, 128, 141, 1);
      --color-error: rgba(192, 21, 47, 1);
      --font-family-base: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      --radius-base: 8px;
      --radius-lg: 12px;
      --space-8: 8px;
      --space-12: 12px;
      --space-16: 16px;
      --space-24: 24px;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --color-background: rgba(31, 33, 33, 1);
        --color-surface: rgba(38, 40, 40, 1);
        --color-text: rgba(245, 245, 245, 1);
        --color-text-secondary: rgba(167, 169, 169, 0.7);
        --color-primary: rgba(50, 184, 198, 1);
        --color-primary-hover: rgba(45, 166, 178, 1);
        --color-border: rgba(119, 124, 124, 0.3);
        --color-card-border: rgba(119, 124, 124, 0.2);
      }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family-base);
      background: var(--color-background);
      color: var(--color-text);
      line-height: 1.6;
      padding: var(--space-24);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1,
    h2 {
      margin-bottom: var(--space-16);
      color: var(--color-text);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-24);
      flex-wrap: wrap;
      gap: var(--space-16);
    }

    .btn {
      padding: var(--space-8) var(--space-16);
      border: none;
      border-radius: var(--radius-base);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--color-primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--color-primary-hover);
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid var(--color-border);
      color: var(--color-text);
    }

    .btn-secondary:hover {
      background: rgba(33, 128, 141, 0.1);
    }

    .btn-danger {
      background: var(--color-error);
      color: white;
    }

    .btn-danger:hover {
      background: rgba(192, 21, 47, 0.9);
    }

    .card {
      background: var(--color-surface);
      border: 1px solid var(--color-card-border);
      border-radius: var(--radius-lg);
      padding: var(--space-24);
      box-shadow: var(--shadow-sm);
      margin-bottom: var(--space-24);
    }

    .form-group {
      margin-bottom: var(--space-16);
    }

    label {
      display: block;
      margin-bottom: var(--space-8);
      font-weight: 500;
      font-size: 14px;
      color: var(--color-text);
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: var(--space-8) var(--space-12);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-base);
      font-size: 14px;
      background: var(--color-surface);
      color: var(--color-text);
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: 2px solid var(--color-primary);
      border-color: var(--color-primary);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    th,
    td {
      padding: var(--space-12);
      text-align: left;
      border-bottom: 1px solid var(--color-border);
    }

    th {
      background: rgba(33, 128, 141, 0.08);
      font-weight: 600;
      color: var(--color-text);
    }

    tr:hover {
      background: rgba(33, 128, 141, 0.05);
    }

    .actions {
      display: flex;
      gap: var(--space-8);
    }

    .hidden {
      display: none;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--color-surface);
      padding: var(--space-24);
      border-radius: var(--radius-lg);
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-16);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--color-text-secondary);
    }

    .alert {
      padding: var(--space-12);
      border-radius: var(--radius-base);
      margin-bottom: var(--space-16);
    }

    .alert-success {
      background: rgba(33, 128, 141, 0.15);
      color: var(--color-success);
      border: 1px solid rgba(33, 128, 141, 0.25);
    }

    .alert-error {
      background: rgba(192, 21, 47, 0.15);
      color: var(--color-error);
      border: 1px solid rgba(192, 21, 47, 0.25);
    }

    .admin-only {
      display: none;
    }

    .admin-view .admin-only {
      display: table-cell;
    }

    .btn-group {
      display: flex;
      gap: var(--space-8);
      flex-wrap: wrap;
    }

    @media (max-width: 768px) {
      body {
        padding: var(--space-16);
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
      }

      table {
        font-size: 12px;
      }

      th,
      td {
        padding: var(--space-8);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>ANGGOTA IPAMA</h1>
        <p id="userStatus" style="color: var(--color-text-secondary); font-size: 14px;">Mode: Pengunjung</p>
      </div>
      <div class="btn-group">
        <button id="loginBtn" class="btn btn-secondary">Login Admin</button>
        <button id="logoutBtn" class="btn btn-secondary hidden">Logout</button>
        <button id="addMemberBtn" class="btn btn-primary">Tambah Anggota</button>
        <button id="exportBtn" class="btn btn-secondary admin-only">Export Data</button>
      </div>
    </div>

    <div id="alertContainer"></div>

    <div class="card">
      <h2>Daftar Anggota</h2>
      <div class="table-container">
        <table id="memberTable">
          <thead>
            <tr>
              <th>Nama</th>
              <th class="admin-only">No WhatsApp</th>
              <th>Prodi</th>
              <th>Kelas</th>
              <th class="admin-only">Alamat</th>
              <th class="admin-only">Alasan Masuk</th>
              <th class="admin-only">Aksi</th>
            </tr>
          </thead>
          <tbody id="memberTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal Login -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Login Admin</h2>
        <button class="close-btn" onclick="closeLoginModal()">&times;</button>
      </div>
      <form id="loginForm">
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" required />
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
      </form>
    </div>
  </div>

  <!-- Modal Tambah/Edit Anggota -->
  <div id="memberModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Tambah Anggota Baru</h2>
        <button class="close-btn" onclick="closeMemberModal()">&times;</button>
      </div>
      <form id="memberForm">
        <input type="hidden" id="editIndex" />
        <div class="form-group">
          <label for="nama">Nama Lengkap *</label>
          <input type="text" id="nama" required />
        </div>
        <div class="form-group">
          <label for="noWa">Nomor WhatsApp *</label>
          <input type="tel" id="noWa" placeholder="08XXXXXXXXXX" required />
        </div>
        <div class="form-group">
          <label for="prodi">Program Studi *</label>
          <input type="text" id="prodi" required />
        </div>
        <div class="form-group">
          <label for="kelas">Kelas *</label>
          <input type="text" id="kelas" required />
        </div>
        <div class="form-group">
          <label for="alamat">Alamat *</label>
          <textarea id="alamat" required></textarea>
        </div>
        <div class="form-group">
          <label for="alasan">Alasan *</label>
          <textarea id="alasan" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Simpan</button>
      </form>
    </div>
  </div>

  <script>
    // =============================
    // MINIMAL CHANGES FOR SHEETS SYNC
    // - Load data from spreadsheet on page load (GET)
    // - Sync add/edit/delete to spreadsheet (POST)
    // - Keep UI & structure the same
    // =============================

    // IMPORTANT:
    // 1) Ganti URL ini dengan URL Web App Apps Script Anda
    // 2) Pastikan Apps Script doGet/doPost mengembalikan JSON
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyvZuRlJFKnkjEvpsv5tIkAjWG0fiya8TC5kTBMIa3op5MNnzC4ov4b8wyMcjMzg8OWyw/exec";

    // Data storage (fallback kalau spreadsheet belum dihubungkan)
    let members = [
      {
        nama: "Ahmad Fauzi",
        noWa: "081234567890",
        prodi: "Teknik Informatika",
        kelas: "TI-3A",
        alamat: "Jl. Merdeka No. 123, Jakarta",
        alasan: "Ingin mengembangkan skill organisasi dan networking",
      },
      {
        nama: "Siti Nurhaliza",
        noWa: "082345678901",
        prodi: "Sistem Informasi",
        kelas: "SI-2B",
        alamat: "Jl. Sudirman No. 45, Bandung",
        alasan: "Tertarik dengan kegiatan sosial dan pengembangan diri",
      },
    ];

    let isAdmin = false;
    const ADMIN_PASSWORD = "ipamawell";

    // Initialize
    document.addEventListener("DOMContentLoaded", async function () {
      // 1) Render cepat pakai fallback dulu
      renderTable();
      updateUIBasedOnRole();

      // 2) Lalu coba load dari Spreadsheet (kalau URL sudah diisi)
      await loadFromSpreadsheet();
    });

    // Login functionality
    document.getElementById("loginBtn").addEventListener("click", function () {
      document.getElementById("loginModal").classList.add("active");
    });

    document.getElementById("loginForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const password = document.getElementById("password").value;

      if (password === ADMIN_PASSWORD) {
        isAdmin = true;
        updateUIBasedOnRole();
        closeLoginModal();
        showAlert("Login berhasil! Anda sekarang dapat mengelola data anggota.", "success");
        document.getElementById("password").value = "";
      } else {
        showAlert("Password salah!", "error");
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", function () {
      isAdmin = false;
      updateUIBasedOnRole();
      showAlert("Logout berhasil.", "success");
    });

    // Add member button
    document.getElementById("addMemberBtn").addEventListener("click", function () {
      document.getElementById("modalTitle").textContent = "Tambah Anggota Baru";
      document.getElementById("memberForm").reset();
      document.getElementById("editIndex").value = "";
      document.getElementById("memberModal").classList.add("active");
    });

    // Member form submission
    document.getElementById("memberForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const memberData = {
        nama: document.getElementById("nama").value,
        noWa: document.getElementById("noWa").value,
        prodi: document.getElementById("prodi").value,
        kelas: document.getElementById("kelas").value,
        alamat: document.getElementById("alamat").value,
        alasan: document.getElementById("alasan").value,
      };

      const editIndex = document.getElementById("editIndex").value;

      if (editIndex === "") {
        // Add new member
        members.push(memberData);
        renderTable();
        closeMemberModal();
        showAlert("Anggota baru berhasil ditambahkan!", "success");

        // Sync add
        await syncToSpreadsheet({ action: "add", payload: memberData });
      } else {
        // Edit existing member
        if (!isAdmin) {
          showAlert("Hanya admin yang dapat mengedit data!", "error");
          return;
        }

        const idx = parseInt(editIndex, 10);
        members[idx] = memberData;
        renderTable();
        closeMemberModal();
        showAlert("Data anggota berhasil diperbarui!", "success");

        // Sync edit (kirim index + payload)
        await syncToSpreadsheet({ action: "edit", index: idx, payload: memberData });
      }
    });

    // Export functionality
    document.getElementById("exportBtn").addEventListener("click", function () {
      if (!isAdmin) {
        showAlert("Hanya admin yang dapat export data!", "error");
        return;
      }

      exportToCSV();
    });

    // Render table
    function renderTable() {
      const tbody = document.getElementById("memberTableBody");
      tbody.innerHTML = "";

      members.forEach((member, index) => {
        const row = document.createElement("tr");

        row.innerHTML = `
          <td>${escapeHtml(member.nama)}</td>
          <td class="admin-only">${escapeHtml(member.noWa)}</td>
          <td>${escapeHtml(member.prodi)}</td>
          <td>${escapeHtml(member.kelas)}</td>
          <td class="admin-only">${escapeHtml(member.alamat)}</td>
          <td class="admin-only">${escapeHtml(member.alasan)}</td>
          <td class="admin-only">
            <div class="actions">
              <button class="btn btn-secondary btn-sm" onclick="editMember(${index})">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="deleteMember(${index})">Hapus</button>
            </div>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    // Edit member
    function editMember(index) {
      if (!isAdmin) {
        showAlert("Hanya admin yang dapat mengedit data!", "error");
        return;
      }

      const member = members[index];
      document.getElementById("modalTitle").textContent = "Edit Data Anggota";
      document.getElementById("editIndex").value = index;
      document.getElementById("nama").value = member.nama;
      document.getElementById("noWa").value = member.noWa;
      document.getElementById("prodi").value = member.prodi;
      document.getElementById("kelas").value = member.kelas;
      document.getElementById("alamat").value = member.alamat;
      document.getElementById("alasan").value = member.alasan;
      document.getElementById("memberModal").classList.add("active");
    }

    // Delete member
    async function deleteMember(index) {
      if (!isAdmin) {
        showAlert("Hanya admin yang dapat menghapus data!", "error");
        return;
      }

      if (confirm("Apakah Anda yakin ingin menghapus anggota ini?")) {
        members.splice(index, 1);
        renderTable();
        showAlert("Data anggota berhasil dihapus.", "success");

        // Sync delete (kirim index)
        await syncToSpreadsheet({ action: "delete", index });
      }
    }

    // Update UI based on role
    function updateUIBasedOnRole() {
      const body = document.body;
      const userStatus = document.getElementById("userStatus");
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");

      if (isAdmin) {
        body.classList.add("admin-view");
        userStatus.textContent = "Mode: Admin";
        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
      } else {
        body.classList.remove("admin-view");
        userStatus.textContent = "Mode: Pengunjung";
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
      }
    }

    // Export to CSV
    function exportToCSV() {
      const headers = ["Nama", "No WhatsApp", "Prodi", "Kelas", "Alamat", "Alasan Masuk"];
      const rows = members.map((m) => [m.nama, m.noWa, m.prodi, m.kelas, m.alamat, m.alasan]);

      let csvContent = headers.join(",") + "\n";
      rows.forEach((row) => {
        csvContent += row.map((field) => `"${String(field).replace(/"/g, '""')}"`).join(",") + "\n";
      });

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", "data_anggota_" + new Date().getTime() + ".csv");
      link.style.visibility = "hidden";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showAlert("Data berhasil di-export!", "success");
    }

    // =============================
    // SPREADSHEET SYNC (GET/POST)
    // =============================

    async function loadFromSpreadsheet() {
      if (!SCRIPT_URL || SCRIPT_URL.includes("PASTE_URL")) {
        // URL belum diisi, pakai data fallback
        return;
      }

      try {
        const res = await fetch(SCRIPT_URL, {
          method: "GET",
          headers: {
            Accept: "application/json",
          },
        });

        if (!res.ok) throw new Error("HTTP " + res.status);

        const data = await res.json();
        if (Array.isArray(data)) {
          // Data dari doGet biasanya sudah format objek {nama,noWa,...}
          members = data.map((x) => ({
            nama: x.nama || "",
            noWa: x.noWa || "",
            prodi: x.prodi || "",
            kelas: x.kelas || "",
            alamat: x.alamat || "",
            alasan: x.alasan || "",
          }));
          renderTable();
          showAlert("Data berhasil dimuat dari Spreadsheet.", "success");
        }
      } catch (err) {
        console.error("Load error:", err);
        // Jangan ganggu UX: cukup info ringan
        showAlert("Gagal memuat dari Spreadsheet. Menggunakan data lokal.", "error");
      }
    }

    async function syncToSpreadsheet(data) {
      if (!SCRIPT_URL || SCRIPT_URL.includes("PASTE_URL")) {
        // URL belum diisi, skip
        console.log("Spreadsheet sync skipped (SCRIPT_URL belum diisi)", data);
        return;
      }

      try {
        // NOTE: kalau Apps Script Anda belum set CORS, pakai mode: 'no-cors'.
        // Tapi jika mode 'no-cors', browser tidak bisa baca response.
        // Rekomendasi: set header CORS di Apps Script (lihat catatan di bawah).
        await fetch(SCRIPT_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });

        console.log("Data synced to spreadsheet:", data);
      } catch (error) {
        console.error("Sync error:", error);
        showAlert("Gagal sinkron ke Spreadsheet.", "error");
      }
    }

    // Show alert
    function showAlert(message, type) {
      const alertContainer = document.getElementById("alertContainer");
      const alert = document.createElement("div");
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      alertContainer.appendChild(alert);

      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    // Close modals
    function closeLoginModal() {
      document.getElementById("loginModal").classList.remove("active");
    }

    function closeMemberModal() {
      document.getElementById("memberModal").classList.remove("active");
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const map = {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#039;",
      };
      return String(text).replace(/[&<>"']/g, (m) => map[m]);
    }

    // Close modal when clicking outside
    window.addEventListener("click", function (event) {
      if (event.target.classList.contains("modal")) {
        event.target.classList.remove("active");
      }
    });
  </script>

  <!--
  CATATAN PENTING (CORS) untuk Apps Script Web App:
  - Jika fetch POST/GET Anda kena CORS, tambahkan header di Apps Script.
  - Contoh (di doGet/doPost sebelum return):
      var output = ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON);
      return output;
    Lalu deploy sebagai Web App: Execute as Me, Who has access Anyone.

  Untuk aksi edit/delete:
  - Anda perlu update Apps Script agar membaca JSON {action,index,payload}.
  - Kalau Anda mau, kirim kode Apps Script Anda, nanti saya sesuaikan (tetap sederhana).
  -->
</body>
</html>
